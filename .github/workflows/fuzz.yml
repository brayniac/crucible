name: Fuzz Testing

on:
  push:
    branches: [main]
    paths:
      - 'cache/core/**'
      - 'protocol/**'
      - 'io/grpc/**'
      - 'io/http2/**'
      - '.github/workflows/fuzz.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cache/core/**'
      - 'protocol/**'
      - 'io/grpc/**'
      - 'io/http2/**'
      - '.github/workflows/fuzz.yml'
  # Allow manual triggering with custom settings
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration per target (seconds)'
        required: false
        default: '60'
      jobs:
        description: 'Parallel fuzz jobs'
        required: false
        default: '2'

env:
  CARGO_TERM_COLOR: always
  # Default duration for scheduled runs (60 seconds per target)
  DEFAULT_DURATION: 60
  DEFAULT_JOBS: 2

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz --locked

      - name: Build xtask
        run: cargo build -p xtask --release

      - name: Discover fuzz targets
        id: discover
        run: |
          # List all fuzz targets for visibility
          echo "Discovered fuzz targets:"
          find . -path '*/fuzz/fuzz_targets/*.rs' -type f | \
            sed 's|.*/fuzz/fuzz_targets/||; s|\.rs$||' | \
            sort | \
            while read target; do echo "  - $target"; done

          # Count targets
          TARGET_COUNT=$(find . -path '*/fuzz/fuzz_targets/*.rs' -type f | wc -l)
          echo "Total: $TARGET_COUNT targets"
          echo "target_count=$TARGET_COUNT" >> $GITHUB_OUTPUT

      - name: Run fuzz tests
        run: |
          # Use workflow inputs if provided, otherwise defaults
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          JOBS="${{ github.event.inputs.jobs || env.DEFAULT_JOBS }}"

          echo "Running fuzz tests:"
          echo "  Duration per target: ${DURATION}s"
          echo "  Parallel jobs: ${JOBS}"
          echo ""

          ./target/release/xtask fuzz-all \
            --duration "$DURATION" \
            --jobs "$JOBS"

      - name: Collect crash artifacts
        if: failure()
        run: |
          echo "Collecting crash artifacts..."
          mkdir -p crash-artifacts

          # Find all fuzz directories with crash artifacts
          for fuzz_dir in $(find . -type d -path '*/fuzz' -exec test -d {}/artifacts \; -print 2>/dev/null || true); do
            echo "Processing $fuzz_dir..."

            for artifact_dir in "$fuzz_dir"/artifacts/*/; do
              [ -d "$artifact_dir" ] || continue
              target_name=$(basename "$artifact_dir")

              for crash_file in "$artifact_dir"crash-* "$artifact_dir"oom-* "$artifact_dir"timeout-*; do
                [ -f "$crash_file" ] || continue

                crash_name=$(basename "$crash_file")
                echo "  Found: $target_name/$crash_name"

                # Copy original
                mkdir -p "crash-artifacts/$target_name"
                cp "$crash_file" "crash-artifacts/$target_name/$crash_name"
              done
            done
          done

          # Show hex dump of crash inputs for quick analysis
          echo ""
          echo "=== Crash Input Analysis ==="
          for f in crash-artifacts/*/*; do
            [ -f "$f" ] || continue
            echo ""
            echo "--- $f ---"
            xxd "$f" | head -20
            echo "Size: $(wc -c < "$f") bytes"
          done

          echo ""
          echo "Total crash artifacts:"
          find crash-artifacts -type f 2>/dev/null | wc -l || echo "0"

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crash-artifacts-${{ github.run_id }}
          path: crash-artifacts/
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## Fuzz Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "All fuzz targets passed." >> $GITHUB_STEP_SUMMARY
          else
            echo "Some fuzz targets failed. Check artifacts for crash details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Duration per target: ${{ github.event.inputs.duration || env.DEFAULT_DURATION }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel jobs: ${{ github.event.inputs.jobs || env.DEFAULT_JOBS }}" >> $GITHUB_STEP_SUMMARY
          echo "- Targets: ${{ steps.discover.outputs.target_count }}" >> $GITHUB_STEP_SUMMARY
