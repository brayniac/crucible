name: Fuzz Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration per target (seconds)'
        required: false
        default: '60'

env:
  CARGO_TERM_COLOR: always
  DEFAULT_DURATION: 60

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      cache-core: ${{ steps.filter.outputs.cache-core }}
      protocol-resp: ${{ steps.filter.outputs.protocol-resp }}
      protocol-memcache: ${{ steps.filter.outputs.protocol-memcache }}
      protocol-momento: ${{ steps.filter.outputs.protocol-momento }}
      protocol-ping: ${{ steps.filter.outputs.protocol-ping }}
      io-grpc: ${{ steps.filter.outputs.io-grpc }}
      io-http2: ${{ steps.filter.outputs.io-http2 }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cache-core:
              - 'cache/core/**'
            protocol-resp:
              - 'protocol/resp/**'
            protocol-memcache:
              - 'protocol/memcache/**'
            protocol-momento:
              - 'protocol/momento/**'
            protocol-ping:
              - 'protocol/ping/**'
            io-grpc:
              - 'io/grpc/**'
            io-http2:
              - 'io/http2/**'

  fuzz-cache-core:
    name: Fuzz cache-core
    needs: changes
    if: needs.changes.outputs.cache-core == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: cache/core/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_basic_header fuzz_ttl_header; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done

  fuzz-protocol-resp:
    name: Fuzz protocol-resp
    needs: changes
    if: needs.changes.outputs.protocol-resp == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: protocol/resp/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_value_parse fuzz_command_parse; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done

  fuzz-protocol-memcache:
    name: Fuzz protocol-memcache
    needs: changes
    if: needs.changes.outputs.protocol-memcache == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: protocol/memcache/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_ascii_command fuzz_ascii_response fuzz_binary_command fuzz_binary_response; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done

  fuzz-protocol-momento:
    name: Fuzz protocol-momento
    needs: changes
    if: needs.changes.outputs.protocol-momento == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: protocol/momento/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_proto_decode fuzz_get_response fuzz_set_request; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done

  fuzz-protocol-ping:
    name: Fuzz protocol-ping
    needs: changes
    if: needs.changes.outputs.protocol-ping == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: protocol/ping/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_response; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done

  fuzz-io-grpc:
    name: Fuzz io-grpc
    needs: changes
    if: needs.changes.outputs.io-grpc == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: io/grpc/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_decode_message fuzz_message_decoder; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done

  fuzz-io-http2:
    name: Fuzz io-http2
    needs: changes
    if: needs.changes.outputs.io-http2 == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-fuzz --locked
      - name: Run fuzz tests
        working-directory: io/http2/fuzz
        run: |
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          for target in fuzz_frame_decode fuzz_hpack_decode; do
            echo "Fuzzing $target for ${DURATION}s..."
            cargo +nightly fuzz run $target -- -max_total_time=$DURATION
          done
