name: Fuzz Testing

on:
  # Run nightly at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration per target (seconds)'
        required: false
        default: '300'
      jobs:
        description: 'Parallel fuzz jobs'
        required: false
        default: '16'

env:
  CARGO_TERM_COLOR: always
  # Default duration for scheduled runs (5 minutes per target)
  DEFAULT_DURATION: 300
  DEFAULT_JOBS: 16

jobs:
  fuzz:
    runs-on: self-hosted
    timeout-minutes: 720  # 12 hours max

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        run: |
          source ~/.cargo/env

          # Ensure nightly is installed
          rustup install nightly
          rustup default nightly

          # Show versions
          rustc --version
          cargo --version

      - name: Install cargo-fuzz
        run: |
          source ~/.cargo/env
          cargo install cargo-fuzz --locked || true
          cargo fuzz --version

      - name: Build xtask
        run: |
          source ~/.cargo/env
          cargo build -p xtask --release

      - name: Discover fuzz targets
        id: discover
        run: |
          source ~/.cargo/env

          # List all fuzz targets for visibility
          echo "Discovered fuzz targets:"
          find . -path '*/fuzz/fuzz_targets/*.rs' -type f | \
            sed 's|.*/fuzz/fuzz_targets/||; s|\.rs$||' | \
            sort | \
            while read target; do echo "  - $target"; done

          # Count targets
          TARGET_COUNT=$(find . -path '*/fuzz/fuzz_targets/*.rs' -type f | wc -l)
          echo "Total: $TARGET_COUNT targets"
          echo "target_count=$TARGET_COUNT" >> $GITHUB_OUTPUT

      - name: Run fuzz tests
        run: |
          source ~/.cargo/env

          # Use workflow inputs if provided, otherwise defaults
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          JOBS="${{ github.event.inputs.jobs || env.DEFAULT_JOBS }}"

          echo "Running fuzz tests:"
          echo "  Duration per target: ${DURATION}s"
          echo "  Parallel jobs: ${JOBS}"
          echo ""

          ./target/release/xtask fuzz-all \
            --duration "$DURATION" \
            --jobs "$JOBS"

      - name: Collect crash artifacts
        if: failure()
        run: |
          echo "Collecting crash artifacts..."
          mkdir -p crash-artifacts

          # Find all crash/oom/timeout files
          find . -path '*/fuzz/artifacts/*' -type f \( \
            -name 'crash-*' -o \
            -name 'oom-*' -o \
            -name 'timeout-*' -o \
            -name 'leak-*' \
          \) -exec cp {} crash-artifacts/ \;

          # List what we found
          echo "Crash artifacts:"
          ls -la crash-artifacts/ || echo "No crash artifacts found"

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crash-artifacts-${{ github.run_id }}
          path: crash-artifacts/
          retention-days: 30
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "## Fuzz Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "All fuzz targets passed." >> $GITHUB_STEP_SUMMARY
          else
            echo "Some fuzz targets failed. Check artifacts for crash details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Duration per target: ${{ github.event.inputs.duration || env.DEFAULT_DURATION }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel jobs: ${{ github.event.inputs.jobs || env.DEFAULT_JOBS }}" >> $GITHUB_STEP_SUMMARY
          echo "- Targets: ${{ steps.discover.outputs.target_count }}" >> $GITHUB_STEP_SUMMARY
